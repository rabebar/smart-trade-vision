<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAIA AI | Newsroom âœï¸</title>
    
    <!-- Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    
    <style>
        body { background: #020617; color: white; font-family: 'Cairo', sans-serif; padding: 40px 20px; }
        .editor-container { max-width: 900px; margin: 0 auto; background: #0b1222; border: 2px solid var(--primary); border-radius: 30px; padding: 40px; box-shadow: 0 0 50px rgba(59, 130, 246, 0.2); }
        .editor-header { text-align: center; margin-bottom: 40px; }
        .editor-header h1 { font-weight: 900; color: var(--primary); font-size: 35px; margin-top: 15px; }
        
        .input-group { margin-bottom: 25px; }
        .input-group label { display: block; margin-bottom: 10px; font-weight: 700; color: var(--muted); font-size: 14px; }
        
        .editor-input { width: 100%; padding: 15px; background: #000; border: 1px solid #333; border-radius: 12px; color: #fff; font-family: inherit; font-size: 16px; outline: none; transition: 0.3s; }
        .editor-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
        .editor-textarea { height: 250px; resize: vertical; line-height: 1.8; }
        
        .publish-btn { width: 100%; height: 70px; background: var(--primary); color: #000; border: none; border-radius: 15px; font-size: 22px; font-weight: 900; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .publish-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4); }
        .publish-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .status-msg { text-align: center; margin-top: 20px; font-weight: 800; padding: 15px; border-radius: 10px; display: none; }
    </style>
</head>
<body>

<div class="editor-container">
    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù„Ø§Ø­Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ù…Ù„Ùƒ -->
<div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
    <button onclick="window.location.href='/admin'" style="background: rgba(255,255,255,0.05); color: #fff; border: 1px solid #333; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 700;">
        <i class="fa-solid fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ·Ø±Ø©
    </button>
    <button onclick="window.location.href='/'" style="background: rgba(59, 130, 246, 0.1); color: var(--primary); border: 1px solid var(--primary); padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 700;">
        Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ <i class="fa-solid fa-external-link"></i>
    </button>
</div>
    <div class="editor-header">
        <img src="/static/logo.png" alt="KAIA" style="height: 60px;">
        <h1>ØºØ±ÙØ© Ø§Ù„ØªØ­Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠ</h1>
        <p style="color: var(--muted); font-weight: 600;">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ùƒ Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø¨Ø±ØºÙˆØ«ÙŠ Ù„Ù†Ø´Ø± Ø§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠØ©</p>
    </div>

    <div id="editor-form">
        <!-- 1. Ù„ØºØ© Ø§Ù„Ù…Ù‚Ø§Ù„ -->
        <div class="input-group">
            <label><i class="fa-solid fa-language"></i> Ù„ØºØ© Ø§Ù„Ù†Ø´Ø±</label>
            <select id="art-lang" class="editor-input" style="background:#1e293b">
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ‡¸ğŸ‡¦</option>
                <option value="en">English ğŸ‡ºğŸ‡¸</option>
            </select>
        </div>

        <!-- 2. Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
        <div class="input-group">
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„</label>
            <input type="text" id="art-title" class="editor-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‡Ù†Ø§...">
        </div>

        <!-- 3. Ø§Ù„Ù…Ù„Ø®Øµ -->
        <div class="input-group">
            <label>Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ù‚Ø§Ù„ (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)</label>
            <input type="text" id="art-summary" class="editor-input" placeholder="Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ø¬Ø°Ø§Ø¨...">
        </div>

        <!-- 4. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© (Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµÙ„Ø­) -->
        <div class="input-group">
            <label><i class="fa-solid fa-camera"></i> Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù</label>
            <input type="file" id="art-image-file" class="editor-input" accept="image/*" onchange="uploadImageToServer()">
            <input type="hidden" id="art-image-url"> <!-- Ù‡Ù†Ø§ ÙŠÙØ®Ø²Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± -->
            <p id="upload-status" style="font-size: 12px; margin-top: 5px; font-weight: 800; display: none;"></p>
        </div>

        <!-- 5. Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
        <div class="input-group">
            <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <textarea id="art-content" class="editor-input editor-textarea" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù‡Ù†Ø§..."></textarea>
        </div>

        <!-- Ø²Ø± Ø§Ù„Ù†Ø´Ø± -->
        <button class="publish-btn" onclick="publishArticle()">
            <i class="fa-solid fa-paper-plane"></i> 
            <span>Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„ Ø§Ù„Ø¢Ù†</span>
        </button>

        <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© -->
        <div id="status-text" class="status-msg"></div>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");

    // 1. Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØºØ±ÙØ©
    async function checkAdminStatus() {
        if (!token) { window.location.href = "/"; return; }
        try {
            const res = await fetch("/api/me", { headers: {"Authorization": "Bearer " + token} });
            const user = await res.json();
            if (!user.is_admin) { window.location.href = "/"; }
        } catch (e) { window.location.href = "/"; }
    }

    // 2. Ø¯Ø§Ù„Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø³ÙŠØ±ÙØ±
    async function uploadImageToServer() {
        const fileInput = document.getElementById("art-image-file");
        const status = document.getElementById("upload-status");
        const urlInput = document.getElementById("art-image-url");

        if (!fileInput.files[0]) return;

        status.style.display = "block";
        status.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";
        status.style.color = "var(--primary)";

        const formData = new FormData();
        formData.append("image", fileInput.files[0]);

        try {
            const res = await fetch("/api/admin/upload-article-image", {
                method: "POST",
                headers: { "Authorization": "Bearer " + token },
                body: formData
            });
            const data = await res.json();
            if (res.ok) {
                urlInput.value = data.image_url;
                status.innerText = "âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!";
                status.style.color = "#10b981";
            } else { alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹"); }
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
    }

    // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ù…ØµÙ„Ø­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
    async function publishArticle() {
        const btn = document.querySelector(".publish-btn");
        const status = document.getElementById("status-text");

        const articleData = {
            title: document.getElementById("art-title").value.trim(),
            summary: document.getElementById("art-summary").value.trim(),
            content: document.getElementById("art-content").value.trim(),
            image_url: document.getElementById("art-image-url").value, // Ø³Ø­Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ø®ÙÙŠØ©
            language: document.getElementById("art-lang").value
        };

        if (!articleData.title || !articleData.content) {
            return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰");
        }

        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...";

        try {
            const response = await fetch("/api/admin/add_article", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify(articleData)
            });

            if (response.ok) {
                status.style.display = "block";
                status.style.color = "#10b981";
                status.innerText = "âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ù…Ù‚Ø§Ù„ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù† Ù„Ù„Ø¬Ù…Ù‡ÙˆØ±.";
                
                // Ù…Ø³Ø­ Ø§Ù„Ø®Ø§Ù†Ø§Øª (Ø¨Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© 100%)
                document.getElementById("art-title").value = "";
                document.getElementById("art-summary").value = "";
                document.getElementById("art-content").value = "";
                document.getElementById("art-image-url").value = "";
                document.getElementById("art-image-file").value = "";
                document.getElementById("upload-status").style.display = "none";
            } else {
                alert("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø´Ø±ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¢Ø¯Ù…Ù†.");
            }
        } catch (error) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.");
        } finally {
            btn.disabled = false;
            btn.innerText = "Ù†Ø´Ø± Ù…Ù‚Ø§Ù„ Ø¬Ø¯ÙŠØ¯";
        }
    }

    window.onload = checkAdminStatus;
</script>
</body>
</html>