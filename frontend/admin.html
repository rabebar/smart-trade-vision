<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CANA Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #050b14; --panel: #111827; --border: #1f2937; --primary: #3b82f6; --accent: #f59e0b; --text: #f3f4f6; }
        body { background: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .header h1 { margin: 0; color: var(--primary); }
        .btn { padding: 8px 15px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
        .btn-refresh { background: var(--panel); color: var(--text); border: 1px solid var(--border); }
        .btn-save { background: var(--primary); color: white; }
        .btn-delete { background: #dc2626; color: white; }
        table { width: 100%; border-collapse: collapse; background: var(--panel); border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #1f2937; color: var(--accent); }
        input[type="number"] { background: #000; border: 1px solid var(--border); color: #fff; padding: 5px; width: 60px; border-radius: 4px; }
        input[type="checkbox"] { transform: scale(1.5); accent-color: var(--primary); }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .badge-admin { background: var(--accent); color: #000; }
        .whale-check { accent-color: #d946ef; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1><i class="fa-solid fa-shield-halved"></i> CANA Admin Panel</h1>
        <button class="btn btn-refresh" onclick="loadUsers()"><i class="fa-solid fa-rotate"></i> Refresh</button>
    </div>
    <div style="overflow-x: auto;">
        <table id="users-table">
            <thead>
                <tr>
                    <th>ID</th><th>Email</th><th>Credits</th><th>Premium?</th><th>Whale VIP? üêã</th><th>Role</th><th>Actions</th>
                </tr>
            </thead>
            <tbody id="users-list"></tbody>
        </table>
    </div>
</div>
<script>
    const token = localStorage.getItem("token");
    if (!token) { alert("Please login as admin first!"); window.location.href = "/"; }
    async function loadUsers() {
        try {
            const res = await fetch("/api/admin/users", { headers: { "Authorization": "Bearer " + token } });
            if (!res.ok) throw new Error("Unauthorized");
            const users = await res.json();
            const tbody = document.getElementById("users-list");
            tbody.innerHTML = "";
            users.forEach(u => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>#${u.id}</td>
                    <td>${u.email}</td>
                    <td><input type="number" id="cred-${u.id}" value="${u.credits}"></td>
                    <td><input type="checkbox" id="prem-${u.id}" ${u.is_premium ? "checked" : ""}></td>
                    <td><input type="checkbox" class="whale-check" id="whale-${u.id}" ${u.is_whale ? "checked" : ""}></td>
                    <td>${u.is_admin ? '<span class="badge badge-admin">ADMIN</span>' : 'User'}</td>
                    <td>
                        <button class="btn btn-save" onclick="saveUser(${u.id})"><i class="fa-solid fa-save"></i></button>
                        ${!u.is_admin ? `<button class="btn btn-delete" onclick="deleteUser(${u.id})"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) { alert("Error loading users: " + e.message); }
    }
    async function saveUser(id) {
        const credits = document.getElementById(`cred-${id}`).value;
        const isPremium = document.getElementById(`prem-${id}`).checked;
        const isWhale = document.getElementById(`whale-${id}`).checked;
        try {
            const res = await fetch("/api/admin/update_user", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                body: JSON.stringify({ user_id: id, credits: parseInt(credits), is_premium: isPremium, is_whale: isWhale })
            });
            if (res.ok) alert("User updated successfully! ‚úÖ"); else alert("Failed to update.");
        } catch (e) { alert("Error: " + e.message); }
    }
    async function deleteUser(id) {
        if(!confirm("Are you sure?")) return;
        try { const res = await fetch(`/api/admin/delete_user/${id}`, { method: "DELETE", headers: { "Authorization": "Bearer " + token } }); if(res.ok) loadUsers(); } catch(e) { alert("Error."); }
    }
    loadUsers();
</script>
</body>
</html>