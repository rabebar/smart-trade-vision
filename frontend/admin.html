<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAIA Admin | Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ·Ø±Ø© ğŸ›°ï¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --bg: #020617; 
            --panel: #0b1222; 
            --border: rgba(255,255,255,0.08); 
            --primary: #3b82f6; 
            --danger: #ef4444; 
            --success: #10b981;
            --text: #f3f4f6; 
            --gold: #ffd700;
            --muted: #94a3b8;
        }
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Cairo', sans-serif; 
            padding: 25px; 
            direction: rtl; 
            visibility: hidden; 
            opacity: 0;
            transition: opacity 0.5s;
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            border-bottom: 2px solid var(--primary); 
            padding-bottom: 15px; 
        }
        .admin-card { 
            background: var(--panel); 
            border-radius: 20px; 
            padding: 25px; 
            border: 1px solid var(--border); 
            overflow-x: auto; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 40px;
        }
        
        .btn-editor {
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            color: white !important;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        table { width: 100%; border-collapse: collapse; text-align: right; min-width: 1200px; }
        th, td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 13px; }
        th { color: var(--primary); font-weight: 900; background: rgba(59, 130, 246, 0.05); }
        
        .row-flagged { background: rgba(239, 68, 68, 0.05) !important; }

        .btn { 
            padding: 8px 14px; 
            border-radius: 8px; 
            cursor: pointer; 
            border: none; 
            font-weight: bold; 
            font-family: inherit; 
            transition: 0.3s; 
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        .btn-save { background: var(--primary); color: white; }
        .btn-save:hover { background: #2563eb; transform: translateY(-2px); }
        
        .btn-verify { background: var(--success); color: white; }
        .btn-flag { background: #4b5563; color: white; }
        .btn-flag.active { background: var(--danger); }
        .btn-renew { background: var(--gold); color: #000; font-size: 10px; padding: 5px 10px; }

        .btn-delete { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-delete:hover { background: var(--danger); color: white; }

        .btn-edit-alt { background: #1e293b; color: #fff; border: 1px solid var(--primary); }
        
        .btn-refresh { background: #1e293b; color: white; border: 1px solid var(--primary); }
        
        input[type="number"], select { 
            background: #000; 
            color: #fff; 
            border: 1px solid var(--border); 
            padding: 6px; 
            border-radius: 6px; 
            text-align: center; 
            font-family: inherit;
        }
        
        .ip-badge {
            background: #1e293b;
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .whatsapp-link { color: #25d366; text-decoration: none; font-weight: 900; background: rgba(37, 211, 102, 0.1); padding: 5px 10px; border-radius: 5px; }
        .badge-premium { background: var(--success); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; }
        .badge-verify { background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; }
        .badge-whale { background: var(--gold); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; }
        
        .expiry-date { color: var(--gold); font-weight: 800; font-size: 11px; display: block; margin-bottom: 4px; }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ø­Ù…Ø± */
.notif-badge {
    background: var(--danger);
    color: white;
    font-size: 11px;
    font-weight: 900;
    padding: 2px 8px;
    border-radius: 20px;
    margin-right: 8px;
    display: none; /* Ø³ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø¬Ø¯Ø¯ */
    box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
/* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ (CRM) --- */
        
        /* Ù†Ù‚Ø·Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ Ø§Ù„ÙˆØ§Ù…Ø¶Ø© */
        .online-dot {
            height: 10px; width: 10px; background-color: var(--success);
            border-radius: 50%; display: inline-block; margin-left: 8px;
            box-shadow: 0 0 8px var(--success);
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; }
        }

        /* Ø¨Ø§Ø¬Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ */
        .badge-paid { background: rgba(16, 185, 129, 0.2); color: var(--success); padding: 3px 8px; border-radius: 6px; font-weight: 900; font-size: 11px; }
        .badge-unpaid { background: rgba(239, 68, 68, 0.2); color: var(--danger); padding: 3px 8px; border-radius: 6px; font-weight: 900; font-size: 11px; }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ (Used / Total) */
        .usage-box { font-size: 11px; font-weight: 700; color: var(--muted); margin-top: 5px; }
        .usage-count { color: var(--primary); font-weight: 900; }

        /* Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ© */
        .fee-input { width: 70px; background: #000; color: var(--gold); border: 1px solid var(--border); border-radius: 6px; padding: 4px; text-align: center; font-weight: 900; font-family: inherit; }
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-item {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .stat-item h3 { font-size: 12px; color: var(--muted); margin-bottom: 5px; }
        .stat-item p { font-size: 20px; font-weight: 900; color: var(--gold); margin: 0; }
        
        /* Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø´Ø§Ù…Ù„ Ø§Ù„Ù…ØªÙˆÙ‡Ø¬ */
        .btn-save-all {
            background: linear-gradient(90deg, #059669, #10b981);
            color: white;
            font-size: 16px;
            padding: 12px 25px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            width: 100%;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="header">
    <h1><i class="fa-solid fa-tower-observation"></i> Ù…Ø±ÙƒØ² Ù‚ÙŠØ§Ø¯Ø© KAIA AI</h1>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-editor" onclick="window.location.href='/editor'">
            <i class="fa-solid fa-pen-nib"></i> ØºØ±ÙØ© Ø§Ù„ØªØ­Ø±ÙŠØ±
        </button>
        <button class="btn btn-refresh" onclick="loadUsers()">
    <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ« 
    <span id="pending-count" class="notif-badge">0</span>
</button>
        <button class="btn btn-save" onclick="window.location.href='/'" style="background: #1e293b;"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>
</div>

<div style="margin-bottom: 25px; background: rgba(59, 130, 246, 0.05); padding: 20px; border-radius: 15px; border: 1px dashed var(--primary);">
    <h2 style="margin: 0; font-size: 20px; font-weight: 900; color: var(--primary);">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø£Ù…Ø§Ù†</h2>
    <p style="margin: 5px 0 0; font-size: 13px; color: var(--muted);">ØªØ­ÙƒÙ… ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§ØªØŒ ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§ØªØŒ ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ØµÙ…Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©.</p>
</div>
<!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„ØªÙ‚Ù†ÙŠ -->
<div class="stats-bar">
    <div class="stat-item">
        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h3>
        <p id="total-users">0</p>
    </div>
    <div class="stat-item">
        <h3>Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© ($)</h3>
        <p id="total-paid">0.00</p>
    </div>
    <div class="stat-item">
        <h3>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹ ($)</h3>
        <p id="total-unpaid" style="color: var(--danger);">0.00</p>
    </div>
    <div class="stat-item">
        <h3>Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø§Ù„Ø¢Ù†</h3>
        <p id="total-online" style="color: var(--success);">0</p>
    </div>
</div>

<!-- Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø´Ø§Ù…Ù„ -->
<button class="btn btn-save-all" onclick="saveAllChanges()">
    <i class="fa-solid fa-cloud-arrow-up"></i> Ø­ÙØ¸ ÙƒØ§ÙØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø­ÙØ¸ Ø´Ø§Ù…Ù„)
</button>
<div class="admin-card">
    <table>
        <thead>
           <tr>
                <th>Ø§Ù„Ù…Ø´ØªØ±Ùƒ ÙˆØ§Ù„Ù†Ø´Ø§Ø·</th>
                <th>Ø§Ù„ØªÙˆØ§ØµÙ„</th>
                <th>Ø¨ØµÙ…Ø© Ø§Ù„Ù€ IP</th>
                <th>ØªÙØ¹ÙŠÙ„</th>
                <th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
                <th>Ø§Ù„Ù…Ø§Ù„ÙŠØ© ($)</th>
                <th>Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="users-list">
            <tr><td colspan="9" style="text-align:center; padding: 50px;">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„ÙŠÙ†...</td></tr>
        </tbody>
    </table>
</div>

<h2 style="margin-bottom: 20px; font-weight: 900; color: var(--gold);"><i class="fa-solid fa-newspaper"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</h2>
<div class="admin-card">
    <table>
        <thead>
            <tr>
                <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th>
                <th>Ø§Ù„Ù„ØºØ©</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
        </thead>
        <tbody id="admin-articles-list">
            <tr><td colspan="4" style="text-align:center; padding: 30px;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const token = localStorage.getItem("token");

    async function checkAdminAuth() {
        if (!token) { window.location.href = "/"; return; }
        try {
            const res = await fetch("/api/me", { headers: { "Authorization": "Bearer " + token } });
            const user = await res.json();
            if (!res.ok || !user.is_admin) { window.location.href = "/"; }
            else {
                document.body.style.visibility = "visible";
                document.body.style.opacity = "1";
                loadUsers();
                loadArticlesForAdmin();
                // Ù‡Ø°Ø§ Ù‡Ùˆ Ø³Ø·Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† ÙŠÙ†Ù‚ØµÙ†Ø§:
                updateNotificationBadge(); 
            }
        } catch (e) { window.location.href = "/"; }
    }

    async function loadUsers() {
        try {
            const res = await fetch("/api/admin/users", { headers: { "Authorization": "Bearer " + token } });
            const users = await res.json();

            // --- Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù„Ø­Ø¸ÙŠØ§Ù‹ ---
            let tPaid = 0, tUnpaid = 0, tOnline = 0;
            users.forEach(u => {
                // Ø­Ø³Ø§Ø¨ Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
                if(u.payment_status === "Paid") tPaid += (u.subscription_fee || 0);
                else tUnpaid += (u.subscription_fee || 0);
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† (Ù…Ù† Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚)
                const lastActive = u.last_active ? new Date(u.last_active) : null;
                if(lastActive && (new Date() - lastActive < 300000)) tOnline++;
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
            document.getElementById("total-users").innerText = users.length;
            document.getElementById("total-paid").innerText = tPaid.toFixed(2);
            document.getElementById("total-unpaid").innerText = tUnpaid.toFixed(2);
            document.getElementById("total-online").innerText = tOnline;
            const tbody = document.getElementById("users-list");
            tbody.innerHTML = users.map(u => {
                const expiry = u.subscription_end ? new Date(u.subscription_end).toLocaleDateString() : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                
                // Ø­Ø³Ø§Ø¨ Ø­Ø§Ù„Ø© "Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†" (Ù†Ø´Ø· Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚)
                const lastActiveDate = u.last_active ? new Date(u.last_active) : null;
                const isOnline = lastActiveDate && (new Date() - lastActiveDate < 300000); 

                return `
                <tr class="${u.is_flagged ? 'row-flagged' : ''}">
                    <td>
                        <div style="display:flex; align-items:center;">
                            ${isOnline ? '<span class="online-dot" title="Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†"></span>' : ''}
                            <div>
                                <div style="font-weight:900;">${u.full_name}</div>
                                <div style="font-size:10px; color:var(--muted);">${u.email}</div>
                                ${u.is_premium ? '<span class="badge-premium">PREMIUM</span>' : ''}
                                ${u.is_whale ? '<span class="badge-whale">KING ğŸ‘‘</span>' : ''}
                            </div>
                        </div>
                    </td>
                    <td><a href="https://wa.me/${u.whatsapp}" target="_blank" class="whatsapp-link"><i class="fa-brands fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨</a></td>
                    <td><span class="ip-badge">${u.registration_ip || '0.0.0.0'}</span></td>
                    <td>
                        <button class="btn btn-verify ${u.is_verified ? '' : 'active'}" onclick="toggleVerify(${u.id}, ${u.is_verified})" title="ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„">
                            <i class="fa-solid ${u.is_verified ? 'fa-user-check' : 'fa-clock'}"></i>
                            ${u.is_verified ? 'Ù…ÙØ¹Ù„' : 'Ø§Ù†ØªØ¸Ø§Ø±'}
                        </button>
                    </td>
                    <td>
                        <select id="tier-${u.id}" onchange="syncTierCredits(${u.id})">
                            <option value="Trial" ${u.tier==='Trial'?'selected':''}>Trial</option>
                            <option value="Basic" ${u.tier==='Basic'?'selected':''}>Basic</option>
                            <option value="Pro" ${u.tier==='Pro'?'selected':''}>Pro</option>
                            <option value="Platinum" ${u.tier==='Platinum'?'selected':''}>Platinum</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" id="fee-${u.id}" value="${u.subscription_fee || 0}" class="fee-input" oninput="recalculateLiveStats()" onchange="saveUser(${u.id})">
                        <select id="pay-status-${u.id}" onchange="recalculateLiveStats(); saveUser(${u.id})" style="font-size:10px; padding:2px; margin-top:5px; width:70px;">
                            <option value="Unpaid" ${u.payment_status==='Unpaid'?'selected':''}>ğŸ”´ Ù„Ù… ÙŠØ¯ÙØ¹</option>
                            <option value="Paid" ${u.payment_status==='Paid'?'selected':''}>ğŸŸ¢ Ù…Ø¯ÙÙˆØ¹</option>
                        </select>
                    </td>
                    <td>
                        <div class="usage-box">
                            Ø­ÙŠØ§Ø© Ø§Ù„Ø­Ø³Ø§Ø¨: <span class="usage-count">${u.total_used_analyzes || 0}</span>
                        </div>
                        <div style="font-size:11px; margin-top:5px; color: var(--gold); font-weight:900;">
                            Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: 
                            <input type="number" id="cred-${u.id}" value="${u.credits}" style="width:40px; background:#000; color:#fff; border:1px solid var(--primary); text-align:center;" onchange="saveUser(${u.id})">
                            <span style="color:var(--muted); margin-right:2px;"> / ${u.tier === 'Trial' ? 3 : u.tier === 'Basic' ? 20 : u.tier === 'Pro' ? 40 : 200}</span>
                        </div>
                    </td>
                    <td>
                        <span class="expiry-date">${expiry}</span>
                        <button class="btn btn-renew" onclick="renewUser(${u.id})"><i class="fa-solid fa-clock-rotate-left"></i> ØªØ¬Ø¯ÙŠØ¯ 30 ÙŠÙˆÙ…</button>
                    </td>
                    <td>
                        <button class="btn btn-flag ${u.is_flagged ? 'active' : ''}" onclick="toggleFlag(${u.id}, ${u.is_flagged})" title="ÙˆØ³Ù… Ù…Ø´Ø¨ÙˆÙ‡">
                            <i class="fa-solid fa-flag"></i>
                        </button>
                        <button class="btn btn-delete" onclick="deleteUser(${u.id}, '${u.full_name}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join("");
        } catch (e) { console.error("Admin Users Error"); }
    }

    async function renewUser(userId) {
        if(!confirm("ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ…Ø§Ù‹ Ø¥Ø¶Ø§ÙÙŠØ©ØŸ")) return;
        try {
            const res = await fetch("/api/admin/update_user", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                body: JSON.stringify({ user_id: userId, renew_subscription: true })
            });
            if (res.ok) loadUsers();
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"); }
    }

    async function toggleVerify(userId, currentStatus) {
        try {
            const res = await fetch("/api/admin/update_user", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                body: JSON.stringify({ user_id: userId, is_verified: !currentStatus })
            });
            if (res.ok) loadUsers();
        } catch (e) { }
    }

    async function toggleFlag(userId, currentStatus) {
        try {
            const res = await fetch("/api/admin/update_user", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                body: JSON.stringify({ user_id: userId, is_flagged: !currentStatus })
            });
            if (res.ok) loadUsers();
        } catch (e) { }
    }

    async function saveUser(userId) {
        const credits = document.getElementById(`cred-${userId}`).value;
        const tier = document.getElementById(`tier-${userId}`).value;
        const fee = document.getElementById(`fee-${userId}`).value;
        const payStatus = document.getElementById(`pay-status-${userId}`).value;

        try {
            const res = await fetch("/api/admin/update_user", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                body: JSON.stringify({ 
                    user_id: userId, 
                    credits: parseInt(credits), 
                    tier: tier, 
                    subscription_fee: parseFloat(fee),
                    payment_status: payStatus,
                    is_premium: (tier !== 'Trial'), 
                    is_whale: (tier === 'Platinum') 
                })
            });
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ù…Ø± ÙÙŠ Ø­Ø§Ù„ ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…
            updateNotificationBadge();
        } catch (e) { console.error("Save Error"); }
    }

    async function deleteUser(userId, name) {
        if (!confirm(`Ø­Ø°Ù Ø­Ø³Ø§Ø¨ (${name})ØŸ`)) return;
        try {
            const res = await fetch(`/api/admin/delete_user/${userId}`, { 
                method: "DELETE", headers: { "Authorization": "Bearer " + token } 
            });
            if (res.ok) loadUsers();
        } catch (e) { }
    }

    async function loadArticlesForAdmin() {
        try {
            const resAr = await fetch("/api/articles?lang=ar");
            const resEn = await fetch("/api/articles?lang=en");
            const artAr = await resAr.json();
            const artEn = await resEn.json();
            const allArts = [...artAr, ...artEn];
            const tbody = document.getElementById("admin-articles-list");
            tbody.innerHTML = allArts.map(art => `
                <tr>
                    <td style="font-weight:700; color:#fff;">${art.title}</td>
                    <td>${art.language === 'ar' ? 'ğŸ‡¸ğŸ‡¦' : 'ğŸ‡ºğŸ‡¸'}</td>
                    <td style="opacity:0.6;">${new Date(art.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-edit-alt" onclick="window.location.href='/editor?edit=${art.id}'">
    <i class="fa-solid fa-pen-to-square"></i> ØªØ¹Ø¯ÙŠÙ„
</button>

<button class="btn btn-delete" onclick="deleteArticle(${art.id}, '${art.title.replace(/'/g, "\\'")}')">
    <i class="fa-solid fa-trash"></i> Ø­Ø°Ù
</button>
                    </td>
                </tr>`).join("");
        } catch (e) { }
    }
// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    async function deleteArticle(id, title) {
        if (!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ: Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù…Ù‚Ø§Ù„ (${title})ØŸ`)) return;

        try {
            const res = await fetch(`/api/admin/delete_article/${id}`, { 
                method: "DELETE", 
                headers: { "Authorization": "Bearer " + token } 
            });

            if (res.ok) {
                alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                loadArticlesForAdmin(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
            } else {
                alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù. Ù‚Ø¯ Ù„Ø§ ØªÙ…Ù„Ùƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§ÙÙŠØ©.");
            }
        } catch (e) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± ğŸ›°ï¸");
        }
    }
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    async function updateNotificationBadge() {
        try {
            const res = await fetch("/api/admin/pending_count", { 
                headers: { "Authorization": "Bearer " + token } 
            });
            const data = await res.json();
            const badge = document.getElementById("pending-count");
            
            if (data.pending_count > 0) {
                badge.innerText = data.pending_count;
                badge.style.display = "inline-block"; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡
            } else {
                badge.style.display = "none"; // Ø¥Ø®ÙØ§Ø¤Ù‡Ø§ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø£Ø­Ø¯
            }
        } catch (e) { console.log("Badge fetch error"); }
    }
    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„ÙƒÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¶ØºØ·Ø© Ø²Ø± ÙˆØ§Ø­Ø¯Ø©
    async function saveAllChanges() {
        const btn = document.querySelector('.btn-save-all');
        const originalText = btn.innerHTML;
        
        // 1. ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ­ÙØ¸ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
        btn.style.opacity = "0.7";
        btn.disabled = true;

        // 2. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø³Ø·Ø± ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const rows = document.querySelectorAll('#users-list tr');
        let processedCount = 0;

        for (let row of rows) {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID) Ù…Ù† Ù…Ø¹Ø±Ù Ø£Ø­Ø¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø·Ø±
            const feeInput = row.querySelector('.fee-input');
            if (!feeInput) continue;
            const userId = feeInput.id.split('-')[1];

            // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø·Ø±
            const credits = document.getElementById(`cred-${userId}`).value;
            const tier = document.getElementById(`tier-${userId}`).value;
            const fee = document.getElementById(`fee-${userId}`).value;
            const payStatus = document.getElementById(`pay-status-${userId}`).value;

            try {
                // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø³ÙŠØ±ÙØ±
                await fetch("/api/admin/update_user", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                    body: JSON.stringify({ 
                        user_id: userId, 
                        credits: parseInt(credits), 
                        tier: tier, 
                        subscription_fee: parseFloat(fee),
                        payment_status: payStatus,
                        is_premium: (tier !== 'Trial'), 
                        is_whale: (tier === 'Platinum') 
                    })
                });
                processedCount++;
            } catch (e) { console.error("Error saving user:", userId); }
        }

        // 3. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ù„ÙˆØ¶Ø¹Ù‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ ÙˆØ¥Ø¹Ù„Ø§Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ø§Ù„Ù†Ø¬Ø§Ø­
        alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù€ (${processedCount}) Ù…Ø´ØªØ±Ùƒ âœ…`);
        btn.innerHTML = originalText;
        btn.style.opacity = "1";
        btn.disabled = false;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
        loadUsers();
        updateNotificationBadge();
    }
    // ÙˆØ¸ÙŠÙØ© Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©)
    function recalculateLiveStats() {
        let tPaid = 0, tUnpaid = 0;
        // Ø¬Ù„Ø¨ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const rows = document.querySelectorAll('#users-list tr');
        
        rows.forEach(row => {
            const feeInput = row.querySelector('.fee-input');
            const payStatusSelect = row.querySelector('select[id^="pay-status-"]');
            
            if (feeInput && payStatusSelect) {
                const feeValue = parseFloat(feeInput.value) || 0;
                if (payStatusSelect.value === "Paid") {
                    tPaid += feeValue;
                } else {
                    tUnpaid += feeValue;
                }
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© ÙÙˆØ±Ø§Ù‹
        document.getElementById("total-paid").innerText = tPaid.toFixed(2);
        document.getElementById("total-unpaid").innerText = tUnpaid.toFixed(2);
    }
    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙˆØ± ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø©
    function syncTierCredits(userId) {
        const tierSelect = document.getElementById(`tier-${userId}`);
        const creditsInput = document.getElementById(`cred-${userId}`);
        
        // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø¢Ù„ÙŠ
        const tierLimits = {"Trial": 3, "Basic": 20, "Pro": 40, "Platinum": 200};
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ù…Ø§Ù… Ø¹ÙŠÙ†Ùƒ ÙÙˆØ±Ø§Ù‹
        creditsInput.value = tierLimits[tierSelect.value];
        
        // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
        saveUser(userId);
    }
    window.onload = checkAdminAuth;
</script>
</body>
</html>