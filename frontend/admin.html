<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAIA Admin | Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ·Ø±Ø© ğŸ›°ï¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --bg: #020617; 
            --panel: #0b1222; 
            --border: rgba(255,255,255,0.08); 
            --primary: #3b82f6; 
            --danger: #ef4444; 
            --success: #10b981;
            --text: #f3f4f6; 
        }
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Cairo', sans-serif; 
            padding: 25px; 
            direction: rtl; 
            visibility: hidden; 
            opacity: 0;
            transition: opacity 0.5s;
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            border-bottom: 2px solid var(--primary); 
            padding-bottom: 15px; 
        }
        .admin-card { 
            background: var(--panel); 
            border-radius: 20px; 
            padding: 25px; 
            border: 1px solid var(--border); 
            overflow-x: auto; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        table { width: 100%; border-collapse: collapse; text-align: right; min-width: 1000px; }
        th, td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        th { color: var(--primary); font-weight: 900; background: rgba(59, 130, 246, 0.05); }
        
        .btn { 
            padding: 10px 18px; 
            border-radius: 8px; 
            cursor: pointer; 
            border: none; 
            font-weight: bold; 
            font-family: inherit; 
            transition: 0.3s; 
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-save { background: var(--primary); color: white; }
        .btn-save:hover { background: #2563eb; transform: translateY(-2px); }
        
        .btn-delete { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-delete:hover { background: var(--danger); color: white; }
        
        .btn-refresh { background: #1e293b; color: white; border: 1px solid var(--primary); }
        
        input[type="number"], select { 
            background: #000; 
            color: #fff; 
            border: 1px solid var(--border); 
            padding: 8px; 
            border-radius: 6px; 
            text-align: center; 
            font-family: inherit;
            outline: none;
        }
        input:focus, select:focus { border-color: var(--primary); }
        
        .whatsapp-link { 
            color: #25d366; 
            text-decoration: none; 
            font-weight: 900; 
            background: rgba(37, 211, 102, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .badge-premium { background: var(--success); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; }
        .badge-verify { background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; margin-right: 5px; }
        .badge-whale { background: #ffd700; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; margin-right: 5px; }
    </style>
</head>
<body>

<div class="header">
    <h1><i class="fa-solid fa-tower-observation"></i> Ù…Ø±ÙƒØ² Ù‚ÙŠØ§Ø¯Ø© KAIA AI</h1>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-refresh" onclick="loadUsers()"><i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«</button>
        <button class="btn btn-save" onclick="window.location.href='/'" style="background: #1e293b;"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>
</div>

<div class="admin-card">
    <table>
        <thead>
            <tr>
                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>Ø§Ù„Ø¯ÙˆÙ„Ø©</th>
                <th>Ø§Ù„ØªÙˆØ§ØµÙ„</th>
                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø¨Ø§Ù‚Ø© (Tier)</th>
                <th>Ø§Ù„Ø±ØµÙŠØ¯ (Credits)</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="users-list">
            <tr><td colspan="8" style="text-align:center; padding: 50px;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„ÙŠÙ† Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const token = localStorage.getItem("token");

    async function checkAdminAuth() {
        if (!token) { window.location.href = "/"; return; }
        try {
            const res = await fetch("/api/me", { headers: { "Authorization": "Bearer " + token } });
            const user = await res.json();
            if (!res.ok || !user.is_admin) {
                alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ùƒ Ø¨Ø¯Ø®ÙˆÙ„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³ÙŠØ·Ø±Ø©!");
                window.location.href = "/";
            } else {
                document.body.style.visibility = "visible";
                document.body.style.opacity = "1";
                loadUsers();
            }
        } catch (e) { window.location.href = "/"; }
    }

    async function loadUsers() {
        try {
            const res = await fetch("/api/admin/users", { 
                headers: { "Authorization": "Bearer " + token } 
            });
            if (!res.ok) return;
            
            const users = await res.json();
            const tbody = document.getElementById("users-list");
            
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>
                        <div style="font-weight:900;">${u.full_name}</div>
                        ${u.is_premium ? '<span class="badge-premium">PREMIUM</span>' : ''}
                    </td>
                    <td><span style="color:#94a3b8;">${u.country}</span></td>
                    <td><a href="https://wa.me/${u.whatsapp}" target="_blank" class="whatsapp-link"><i class="fa-brands fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨</a></td>
                    <td style="color:#64748b; font-size:12px;">${u.email}</td>
                    <td>
                        ${u.is_verified ? '<span class="badge-verify">Ù…ÙØ¹Ù„ âœ…</span>' : '<span class="badge-verify" style="background:#4b5563;">Ø§Ù†ØªØ¸Ø§Ø± â³</span>'}
                        ${u.is_whale ? '<span class="badge-whale">KING ğŸ‘‘</span>' : ''}
                    </td>
                    <td>
                        <select id="tier-${u.id}">
                            <option value="Trial" ${u.tier==='Trial'?'selected':''}>Trial</option>
                            <option value="Basic" ${u.tier==='Basic'?'selected':''}>Basic</option>
                            <option value="Pro" ${u.tier==='Pro'?'selected':''}>Pro</option>
                            <option value="Platinum" ${u.tier==='Platinum'?'selected':''}>Platinum</option>
                        </select>
                    </td>
                    <td><input type="number" id="cred-${u.id}" value="${u.credits}" style="width: 70px;"></td>
                    <td>
                        <button class="btn btn-save" onclick="saveUser(${u.id})" title="Ø­ÙØ¸">
                            <i class="fa-solid fa-floppy-disk"></i>
                        </button>
                        <button class="btn btn-delete" onclick="deleteUser(${u.id}, '${u.full_name}')" title="Ø­Ø°Ù">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </td>
                </tr>
            `).join("");
        } catch (e) { console.error("Admin Fetch Error"); }
    }

    async function saveUser(userId) {
        const credits = document.getElementById(`cred-${userId}`).value;
        const tier = document.getElementById(`tier-${userId}`).value;
        
        try {
            const res = await fetch("/api/admin/update_user", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "Authorization": "Bearer " + token 
                },
                body: JSON.stringify({ 
                    user_id: userId, 
                    credits: parseInt(credits), 
                    tier: tier,
                    is_premium: (tier !== 'Trial'),
                    is_whale: (tier === 'Platinum') // ØªØ±Ù‚ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ø±ØªØ¨Ø© Ø§Ù„Ù…Ù„Ùƒ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø§Ù‚Ø© Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ…
                })
            });
            
            if (res.ok) {
                alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­");
                loadUsers();
            } else {
                alert("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
            }
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"); }
    }

    async function deleteUser(userId, name) {
        if (!confirm(`ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ (${name}) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©ØŸ`)) return;
        
        try {
            const res = await fetch(`/api/admin/delete_user/${userId}`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });
            if (res.ok) {
                alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ ÙˆØ§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                loadUsers();
            } else {
                const err = await res.json();
                alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + (err.detail || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
            }
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"); }
    }

    window.onload = checkAdminAuth;
</script>
</body>
</html>