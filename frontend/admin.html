<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAIA Admin | Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ·Ø±Ø© ğŸ›°ï¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --bg: #020617; 
            --panel: #0b1222; 
            --border: rgba(255,255,255,0.08); 
            --primary: #3b82f6; 
            --danger: #ef4444; 
            --success: #10b981;
            --text: #f3f4f6; 
            --gold: #ffd700;
        }
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Cairo', sans-serif; 
            padding: 25px; 
            direction: rtl; 
            visibility: hidden; 
            opacity: 0;
            transition: opacity 0.5s;
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            border-bottom: 2px solid var(--primary); 
            padding-bottom: 15px; 
        }
        .admin-card { 
            background: var(--panel); 
            border-radius: 20px; 
            padding: 25px; 
            border: 1px solid var(--border); 
            overflow-x: auto; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 40px;
        }
        
        .btn-editor {
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            color: white !important;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        table { width: 100%; border-collapse: collapse; text-align: right; min-width: 1000px; }
        th, td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        th { color: var(--primary); font-weight: 900; background: rgba(59, 130, 246, 0.05); }
        
        .btn { 
            padding: 10px 18px; 
            border-radius: 8px; 
            cursor: pointer; 
            border: none; 
            font-weight: bold; 
            font-family: inherit; 
            transition: 0.3s; 
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        .btn-save { background: var(--primary); color: white; }
        .btn-save:hover { background: #2563eb; transform: translateY(-2px); }
        
        .btn-delete { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-delete:hover { background: var(--danger); color: white; }
        
        .btn-refresh { background: #1e293b; color: white; border: 1px solid var(--primary); }
        
        input[type="number"], select { 
            background: #000; 
            color: #fff; 
            border: 1px solid var(--border); 
            padding: 8px; 
            border-radius: 6px; 
            text-align: center; 
            font-family: inherit;
            outline: none;
        }
        input:focus, select:focus { border-color: var(--primary); }
        
        .whatsapp-link { 
            color: #25d366; 
            text-decoration: none; 
            font-weight: 900; 
            background: rgba(37, 211, 102, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .badge-premium { background: var(--success); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; }
        .badge-verify { background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; margin-right: 5px; }
        .badge-whale { background: var(--gold); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; margin-right: 5px; }
    </style>
</head>
<body>

<div class="header">
    <h1><i class="fa-solid fa-tower-observation"></i> Ù…Ø±ÙƒØ² Ù‚ÙŠØ§Ø¯Ø© KAIA AI</h1>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-editor" onclick="window.location.href='/editor'">
            <i class="fa-solid fa-pen-nib"></i> ØºØ±ÙØ© Ø§Ù„ØªØ­Ø±ÙŠØ±
        </button>
        <button class="btn btn-refresh" onclick="location.reload()"><i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«</button>
        <button class="btn btn-save" onclick="window.location.href='/'" style="background: #1e293b;"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>
</div>

<!-- Ø¨Ø§Ù†Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ -->
<div style="margin-bottom: 25px; display: flex; align-items: center; justify-content: space-between; background: rgba(59, 130, 246, 0.05); padding: 20px; border-radius: 15px; border: 1px dashed var(--primary);">
    <div>
        <h2 style="margin: 0; font-size: 20px; font-weight: 900; color: var(--primary);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù…</h2>
        <p style="margin: 5px 0 0; font-size: 13px; color: var(--muted);">Ø§Ù†Ø´Ø± Ø±Ø¤ÙŠØªÙƒ Ø§Ù„ÙÙ†ÙŠØ©ØŒ Ø­Ø¯Ø« Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¨Ø§Ø±ØŒ ÙˆØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù† Ù‡Ù†Ø§.</p>
    </div>
    <button class="btn btn-editor" style="height: 50px; padding: 0 30px; font-size: 16px;" onclick="window.location.href='/editor'">
        <i class="fa-solid fa-paper-plane"></i> Ø¯Ø®ÙˆÙ„ ØºØ±ÙØ© Ø§Ù„ØªØ­Ø±ÙŠØ±
    </button>
</div>

<!-- 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
<h2 style="margin-bottom: 20px; font-weight: 900;"><i class="fa-solid fa-users-gear"></i> Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù†ØµØ©</h2>
<div class="admin-card">
    <table>
        <thead>
            <tr>
                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>Ø§Ù„Ø¯ÙˆÙ„Ø©</th>
                <th>Ø§Ù„ØªÙˆØ§ØµÙ„</th>
                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø¨Ø§Ù‚Ø© (Tier)</th>
                <th>Ø§Ù„Ø±ØµÙŠØ¯ (Credits)</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="users-list">
            <tr><td colspan="8" style="text-align:center; padding: 50px;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„ÙŠÙ†...</td></tr>
        </tbody>
    </table>
</div>

<!-- 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª (Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…ØµÙ„Ø­Ø©) -->
<h2 style="margin-bottom: 20px; font-weight: 900; color: var(--gold);"><i class="fa-solid fa-newspaper"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</h2>
<div class="admin-card">
    <table>
        <thead>
            <tr>
                <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th>
                <th>Ø§Ù„Ù„ØºØ©</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
        </thead>
        <tbody id="admin-articles-list">
            <tr><td colspan="4" style="text-align:center; padding: 30px;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const token = localStorage.getItem("token");

    async function checkAdminAuth() {
        if (!token) { window.location.href = "/"; return; }
        try {
            const res = await fetch("/api/me", { headers: { "Authorization": "Bearer " + token } });
            const user = await res.json();
            if (!res.ok || !user.is_admin) {
                alert("ğŸ”’ Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ø¸ÙˆØ±Ø©: Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ù„Ùƒ ÙÙ‚Ø·!");
                window.location.href = "/";
            } else {
                document.body.style.visibility = "visible";
                document.body.style.opacity = "1";
                loadUsers();
                loadArticlesForAdmin(); // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª ÙÙˆØ± Ø§Ù„Ø¯Ø®ÙˆÙ„
            }
        } catch (e) { window.location.href = "/"; }
    }

    async function loadUsers() {
        try {
            const res = await fetch("/api/admin/users", { headers: { "Authorization": "Bearer " + token } });
            const users = await res.json();
            const tbody = document.getElementById("users-list");
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td><div style="font-weight:900;">${u.full_name}</div>${u.is_premium ? '<span class="badge-premium">PREMIUM</span>' : ''}</td>
                    <td><span style="color:#94a3b8;">${u.country}</span></td>
                    <td><a href="https://wa.me/${u.whatsapp}" target="_blank" class="whatsapp-link"><i class="fa-brands fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨</a></td>
                    <td style="color:#64748b; font-size:12px;">${u.email}</td>
                    <td>
                        ${u.is_verified ? '<span class="badge-verify">Ù…ÙØ¹Ù„ âœ…</span>' : '<span class="badge-verify" style="background:#4b5563;">Ø§Ù†ØªØ¸Ø§Ø± â³</span>'}
                        ${u.is_whale ? '<span class="badge-whale">KING ğŸ‘‘</span>' : ''}
                    </td>
                    <td>
                        <select id="tier-${u.id}">
                            <option value="Trial" ${u.tier==='Trial'?'selected':''}>Trial</option>
                            <option value="Basic" ${u.tier==='Basic'?'selected':''}>Basic</option>
                            <option value="Pro" ${u.tier==='Pro'?'selected':''}>Pro</option>
                            <option value="Platinum" ${u.tier==='Platinum'?'selected':''}>Platinum</option>
                        </select>
                    </td>
                    <td><input type="number" id="cred-${u.id}" value="${u.credits}" style="width: 70px;"></td>
                    <td>
                        <button class="btn btn-save" onclick="saveUser(${u.id})"><i class="fa-solid fa-floppy-disk"></i></button>
                        <button class="btn btn-delete" onclick="deleteUser(${u.id}, '${u.full_name}')"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                </tr>
            `).join("");
        } catch (e) { console.error("Admin Users Error"); }
    }

    // [Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©] Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ù„Ù„Ø¢Ø¯Ù…Ù†
    async function loadArticlesForAdmin() {
        try {
            const resAr = await fetch("/api/articles?lang=ar");
            const resEn = await fetch("/api/articles?lang=en");
            const artAr = await resAr.json();
            const artEn = await resEn.json();
            const allArts = [...artAr, ...artEn];

            const tbody = document.getElementById("admin-articles-list");
            if (allArts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª Ù…Ù†Ø´ÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>';
                return;
            }

            tbody.innerHTML = allArts.map(art => `
                <tr>
                    <td style="font-weight:700;">${art.title}</td>
                    <td>${art.language === 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ‡¸ğŸ‡¦' : 'English ğŸ‡ºğŸ‡¸'}</td>
                    <td style="opacity:0.6;">${new Date(art.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-delete" onclick="deleteKAIAArticle(${art.id})">
                            <i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø§Ù„
                        </button>
                    </td>
                </tr>
            `).join("");
        } catch (e) { console.error("Admin Articles Error"); }
    }

    // [Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©] Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
    async function deleteKAIAArticle(id) {
        if (!confirm("ÙŠØ§ Ù…Ù„ÙƒØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!")) return;
        try {
            const res = await fetch(`/api/admin/delete_article/${id}`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });
            if (res.ok) {
                alert("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­.");
                loadArticlesForAdmin();
            }
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
    }

    async function saveUser(userId) {
        const credits = document.getElementById(`cred-${userId}`).value;
        const tier = document.getElementById(`tier-${userId}`).value;
        try {
            const res = await fetch("/api/admin/update_user", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                body: JSON.stringify({ user_id: userId, credits: parseInt(credits), tier: tier, is_premium: (tier !== 'Trial'), is_whale: (tier === 'Platinum') })
            });
            if (res.ok) { alert("âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); loadUsers(); }
        } catch (e) { alert("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"); }
    }

    async function deleteUser(userId, name) {
        if (!confirm(`Ø­Ø°Ù Ø­Ø³Ø§Ø¨ (${name})ØŸ`)) return;
        try {
            const res = await fetch(`/api/admin/delete_user/${userId}`, { method: "DELETE", headers: { "Authorization": "Bearer " + token } });
            if (res.ok) { alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù"); loadUsers(); }
        } catch (e) { alert("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"); }
    }

    window.onload = checkAdminAuth;
</script>
</body>
</html>