<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± - SmartTrade</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #0f172a; color: white; font-family: 'Cairo', sans-serif; padding: 30px; }
        .container { max-width: 1100px; margin: 0 auto; background: #1e293b; padding: 30px; border-radius: 15px; border: 1px solid #334155; }
        
        h1 { color: #f59e0b; text-align: center; margin-bottom: 30px; }
        .back-link { display: inline-block; color: #94a3b8; text-decoration: none; margin-bottom: 20px; font-weight: bold; }
        .back-link:hover { color: white; }

        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        th { padding: 15px; text-align: right; color: #94a3b8; font-size: 0.9rem; }
        
        td { background: #0f172a; padding: 15px; border-top: 1px solid #334155; border-bottom: 1px solid #334155; }
        td:first-child { border-right: 1px solid #334155; border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        td:last-child { border-left: 1px solid #334155; border-top-left-radius: 8px; border-bottom-left-radius: 8px; }

        input[type="number"] { background: #1e293b; border: 1px solid #475569; color: #f59e0b; padding: 8px; border-radius: 6px; width: 80px; text-align: center; font-weight: bold; }
        input[type="checkbox"] { transform: scale(1.5); accent-color: #f59e0b; cursor: pointer; }
        
        .btn { cursor: pointer; padding: 8px 15px; border-radius: 6px; border: none; font-weight: bold; transition: 0.2s; color: white; margin-left: 5px; }
        .save-btn { background: #10b981; }
        .save-btn:hover { background: #059669; }
        
        .del-btn { background: #ef4444; }
        .del-btn:hover { background: #dc2626; }

        .admin-badge { background: #f59e0b; color: black; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <a href="/" class="back-link"><i class="fa-solid fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹</a>
        <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
        
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                    <th>VIP</th>
                    <th>Ø§Ù„ØªØ­ÙƒÙ…</th>
                </tr>
            </thead>
            <tbody id="users-table">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
            </tbody>
        </table>
    </div>

    <script>
        const token = localStorage.getItem("token");
        if (!token) window.location.href = "/";

        async function loadUsers() {
            try {
                const res = await fetch("/api/admin/users", {
                    headers: { "Authorization": "Bearer " + token }
                });
                
                if (res.status === 403) {
                    document.body.innerHTML = "<h2 style='text-align:center; color:red; margin-top:50px;'>â›” Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø®ÙˆÙ„! Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡ ÙÙ‚Ø·.</h2>";
                    return;
                }

                const users = await res.json();
                const tbody = document.getElementById("users-table");
                tbody.innerHTML = "";

                users.forEach(user => {
                    const isAdminBadge = user.is_admin ? '<span class="admin-badge">ADMIN</span>' : '';
                    
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td style="color:#64748b;">#${user.id}</td>
                        <td>
                            ${user.email} ${isAdminBadge}
                            <div style="font-size:0.8rem; color:#64748b;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø´ÙØ±Ø©</div>
                        </td>
                        <td><input type="number" value="${user.credits}" id="c-${user.id}"></td>
                        <td><input type="checkbox" ${user.is_premium ? 'checked' : ''} id="v-${user.id}"></td>
                        <td>
                            <button class="btn save-btn" onclick="saveUser(${user.id})" title="Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"><i class="fa-solid fa-check"></i> Ø­ÙØ¸</button>
                            ${!user.is_admin ? `<button class="btn del-btn" onclick="deleteUser(${user.id})" title="Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            }
        }

        async function saveUser(id) {
            const credits = document.getElementById(`c-${id}`).value;
            const isPremium = document.getElementById(`v-${id}`).checked;

            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) {
                const res = await fetch("/api/admin/update_user", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({ user_id: id, credits: parseInt(credits), is_premium: isPremium })
                });

                if (res.ok) alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!");
                else alert("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
            }
        }

        async function deleteUser(id) {
            if(confirm("âš ï¸ ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ±!\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
                const res = await fetch(`/api/admin/delete_user/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": "Bearer " + token }
                });

                if (res.ok) {
                    alert("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.");
                    loadUsers(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                } else {
                    const data = await res.json();
                    alert("âŒ Ø®Ø·Ø£: " + data.detail);
                }
            }
        }

        loadUsers();
    </script>
</body>
</html>