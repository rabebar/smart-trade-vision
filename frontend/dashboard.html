<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAIA AI | Command Center ğŸš€</title>

    <!-- [Ø­Ù‚Ù†] ØªØ­ÙˆÙŠÙ„ ÙÙˆØ±ÙŠ ÙˆÙ…Ø¤ÙƒØ¯ Ù„Ù„Ø¬ÙˆØ§Ù„ -->
    <script>
        if (window.innerWidth <= 768) {
            window.location.href = "/mobile";
        }
    </script>

    <!-- Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">

    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¤ÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù† Ù„ØºØ±ÙØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© */
        body {
            visibility: hidden;
            opacity: 0;
            background: #020617;
            transition: opacity 0.5s ease;
            padding-bottom: 50px; /* Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…ÙÙƒØ±Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
        }

        /* Ø¯Ø¹Ù… ØªØºÙŠÙŠØ± Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ (RTL/LTR) */
        body.ltr {
            direction: ltr;
            text-align: left;
        }

        body.ltr .top-navbar,
        body.ltr .workspace-container,
        body.ltr .card-header,
        body.ltr .notes-section {
            text-align: left;
        }

        body.ltr .header-right { order: 1; }
        body.ltr .header-left  { order: 2; }

        /* Ù‡ÙŠÙƒÙ„Ø© Ù…Ø­Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© */
        .workspace-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 110px);
        }

        /* Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (ØªØ­Ù„ÙŠÙ„ + Ø­Ø§Ø³Ø¨Ø©) */
        .sidebar-tools {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 340px;
            overflow-y: auto;
        }

        /* Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© (Ø§Ù„Ø´Ø§Ø±Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…) */
        .main-chart-area {
            flex: 7;
            background: var(--bg-panel);
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .analysis-mini-core {
            background: var(--bg-panel);
            border-radius: 20px;
            border: 2px solid var(--primary);
            padding: 25px;
            position: relative;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .calc-mini {
            background: var(--bg-panel);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 15px;
        }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ù…Ø·ÙˆØ± (Modals) */
        .floating-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }
        .modal-box {
            background: var(--bg-panel);
            border: 2px solid var(--primary);
            padding: 35px;
            border-radius: 30px;
            width: 95%;
            max-width: 480px;
            position: relative;
            box-shadow: 0 0 50px var(--primary-glow);
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .tool-icon-btn {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 10px 15px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 800;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: 0.3s;
            min-width: 100px;
        }

        .tool-icon-btn:hover {
            background: var(--primary);
            color: #000;
            transform: translateY(-2px);
        }

        .lang-picker-dash {
            background: #0f172a;
            color: white;
            border: 1px solid var(--primary);
            padding: 5px 12px;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            font-weight: 800;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
        .notes-section {
            padding: 0 20px;
            margin-top: 30px;
            width: 100%;
        }

        .trader-journal-area {
            width: 100%;
            height: 250px;
            background: #050b14;
            color: #fff;
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            font-family: inherit;
            font-size: 16px;
            outline: none;
            resize: vertical;
            transition: 0.3s;
        }

        .trader-journal-area:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø±ÙŠØ· Ø¬Ù„Ø³Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ */
        .market-sessions-bar {
            background: #050b14;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 8px 0;
            font-size: 12px;
            font-weight: 800;
        }

        .session-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
            transition: 0.3s;
        }

        .session-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #334155;
        }
        .session-active { color: #fff; }
        .session-active .session-dot {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆÙ†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª */
        .help-trigger {
            cursor: pointer;
            color: var(--muted);
            font-size: 18px;
            transition: 0.3s;
        }
        .help-trigger:hover {
            color: var(--primary);
            transform: scale(1.1);
        }

        .instruction-box {
            display: none;
            position: absolute;
            top: 60px;
            right: 25px;
            left: 25px;
            background: #0f172a;
            border: 1px solid var(--primary);
            border-radius: 15px;
            padding: 20px;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±ØªØ¨ Ø§Ù„Ù…Ù„ÙƒÙŠØ© */
        .user-info-capsule {
            padding: 8px 15px !important;
            font-size: 13px !important;
            border: 1px solid var(--primary);
            border-radius: 50px;
            background: rgba(59, 130, 246, 0.05);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .rank-icon { font-size: 20px; vertical-align: middle; margin: 0 5px; }
        .tier-platinum { color: #3b82f6 !important; }
        .tier-pro { color: #ffd700 !important; }
        .tier-basic { color: #c0c0c0 !important; }
        .tier-trial { color: #8b4513 !important; }

        /* --- [ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠØ© - Ù†Ø³Ø®Ø© Ù†Ø¸ÙŠÙØ©] --- */
        .verification-alert-bar {
            display: none; background: linear-gradient(90deg, #1e293b, #0f172a);
            border-bottom: 2px solid #3b82f6; padding: 15px; text-align: center;
            position: relative; z-index: 1000;
        }
        .v-content { display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .v-text { font-weight: 800; color: #fff; font-size: 14px; }
        .v-btn { background: #3b82f6; color: #000; padding: 8px 20px; border-radius: 8px; text-decoration: none; font-weight: 900; }

        .report-bullish { border: 2px solid #10b981 !important; box-shadow: 0 0 25px rgba(16, 185, 129, 0.2) !important; }
        .report-bearish { border: 2px solid #ef4444 !important; box-shadow: 0 0 25px rgba(239, 68, 68, 0.2) !important; }
        .report-neutral { border: 2px solid #3b82f6 !important; }
        .bias-text-bull { color: #10b981; font-weight: 900; }
        .bias-text-bear { color: #ef4444; font-weight: 900; }
    </style>
</head>
<body class="dashboard-root">
    <div id="activation-banner" class="verification-alert-bar">
        <div class="v-content">
            <i class="fa-solid fa-shield-halved" style="color:#3b82f6; font-size: 20px;"></i>
            <span class="v-text">Ø­Ø³Ø§Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠØ©.. Ù„ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø§Øª KAIA AI ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø­Ù„Ù„.</span>
            <a id="whatsapp-verify-link" href="#" target="_blank" class="v-btn"><i class="fa-brands fa-whatsapp"></i> ØªÙØ¹ÙŠÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
        </div>
    </div>
    <!-- ================= 1. Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ù…Ø·ÙˆØ± Ù„ØºØ±ÙØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ================= -->
<header class="top-navbar">

    <div class="header-left" style="display: flex; align-items: center; gap: 12px;">

        <button class="nav-btn-logout" id="logout-btn" title="Exit">
            <i class="fa-solid fa-power-off"></i>
        </button>

        <!-- Ø²Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØµØ© -->
        <button class="tool-icon-btn" onclick="location.reload()" title="Refresh System">
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-arrows-rotate"></i>
                <span data-i18n="dash_refresh_btn">ØªØ­Ø¯ÙŠØ«</span>
            </div>
            <small style="font-size: 9px; opacity: 0.7;">Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</small>
        </button>

        <button class="wallet-btn" onclick="window.location.href='/'" title="Home">
            <i class="fa-solid fa-house"></i>
        </button>

        <!-- Ø²Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± -->
        <button class="tool-icon-btn" onclick="document.getElementById('risk-modal').style.display='flex'">
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-shield-halved"></i>
                <span data-i18n="dash_risk_title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span>
            </div>
        </button>

        <!-- Ø²Ø± ÙØªØ­ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¨ÙŠØ¨Ø³ -->
        <button class="tool-icon-btn" onclick="document.getElementById('pip-modal').style.display='flex'">
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-calculator"></i>
                <span data-i18n="dash_pip_calc_title">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø·</span>
            </div>
        </button>

        <!-- Ø²Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª -->
        <button class="tool-icon-btn" onclick="window.location.href='/history'">
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-clock-rotate-left"></i>
                <span data-i18n="dash_history_title">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
            </div>
        </button>

        <div class="user-info-capsule">
            <span id="rank-icon-place"></span>
            <span class="user-credits">
                <i class="fa-solid fa-coins"></i>
                <span id="dash-credits">0</span>
            </span>
            <span class="user-name">
                <span data-i18n="nav_welcome">Ø£Ù‡Ù„Ø§Ù‹ØŒ</span>
                <span id="dash-user">ØªØ­Ù…ÙŠÙ„...</span> ğŸ‘‘
            </span>
        </div>

    </div>

    <div class="header-right" style="display: flex; align-items: center; gap: 20px;">
        <select class="lang-picker-dash" id="language-select">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ‡¸ğŸ‡¦</option>
            <option value="en">English ğŸ‡ºğŸ‡¸</option>
            <option value="fr">FranÃ§ais ğŸ‡«ğŸ‡·</option>
            <option value="es">EspaÃ±ol ğŸ‡ªğŸ‡¸</option>
            <option value="it">Italiano ğŸ‡®ğŸ‡¹</option>
        </select>

        <div class="logo-main" onclick="window.location.href='/'" style="cursor:pointer">
            <span class="logo-text">KAIA AI</span>
            <img src="/static/logo.png" alt="Logo" style="height:40px; margin-right:10px;">
        </div>
    </div>
</header>

<!-- ================= Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø£Ø³ÙÙ„ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ ================= -->
<div class="market-sessions-bar">
    <div class="session-item" id="session-sydney"><div class="session-dot"></div><span>SYDNEY</span></div>
    <div class="session-item" id="session-tokyo"><div class="session-dot"></div><span>TOKYO</span></div>
    <div class="session-item" id="session-london"><div class="session-dot"></div><span>LONDON</span></div>
    <div class="session-item" id="session-newyork"><div class="session-dot"></div><span>NEW YORK</span></div>
</div>
<!-- ================= 2. Ù…Ø­Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„Ø´Ø§Ø±Øª ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„) ================= -->
<main class="workspace-container">

    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ: Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ†ÙÙŠØ° -->
    <aside class="sidebar-tools">

        <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠ Ø§Ù„Ø°ÙƒÙŠ -->
        <div class="analysis-mini-core">

            <div style="margin-bottom: 20px; font-weight: 900; color: var(--primary); display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span data-i18n="analysis_header">Ù…Ø­Ø±Ùƒ KAIA AI</span>
                    <i class="fa-solid fa-circle-question help-trigger" onclick="document.getElementById('help-box').style.display='block'" title="ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…"></i>
                </div>
                <i class="fa-solid fa-brain" style="font-size: 22px;"></i>
            </div>

            <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© -->
            <div class="instruction-box" id="help-box">
                <h4 data-i18n="help_title"><i class="fa-solid fa-lightbulb"></i> Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ø±Ùƒ</h4>
                <ul class="instruction-list">
                    <li><i class="fa-solid fa-1"></i><span data-i18n="help_step_1">Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø´Ø§Ø±Øª: Ù‚Ù… Ø¨Ù„ØµÙ‚ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø§Ø±Øª Ù…Ø¨Ø§Ø´Ø±Ø© (Paste) Ø£Ùˆ Ø§Ø±ÙØ¹Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹.</span></li>
                    <li><i class="fa-solid fa-2"></i><span data-i18n="help_step_2">ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙØ±ÙŠÙ…: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ… Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø´Ø§Ø±Øª.</span></li>
                </ul>
                <button onclick="document.getElementById('help-box').style.display='none'"
                        data-i18n="help_btn"
                        style="width:100%; margin-top:10px; background:rgba(59, 130, 246, 0.1); color:var(--primary); border:1px solid var(--primary); height:35px; border-radius:8px; cursor:pointer; font-weight:800; font-size:12px;">
                    ÙÙ‡Ù…Øª Ø°Ù„Ùƒ
                </button>
            </div>

            <!-- Ù…Ù†Ø·Ù‚Ø© Ø±ÙØ¹ Ø§Ù„Ø´Ø§Ø±Øª -->
            <div class="drop-zone-v2" id="drop-zone" onclick="document.getElementById('chartUpload').click()" style="padding: 35px; border-radius: 15px; background: rgba(0,0,0,0.3); text-align:center; cursor:pointer;">
                <h4 id="status-text" data-i18n="drop_zone_text" style="font-size: 17px; font-weight: 900;">Ø¥Ù„ØµÙ‚ Ø§Ù„Ø´Ø§Ø±Øª Ù‡Ù†Ø§ ğŸ“¸</h4>
                <input type="file" id="chartUpload" style="display: none;" accept="image/*" onchange="handleDesktopImage(event)">
            </div>

            <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ÙˆØ§Ù„ÙØ±ÙŠÙ… -->
            <div class="core-inputs-grid" style="display: grid; gap: 12px; margin: 20px 0;">
                <select id="strategy" style="height: 50px; background: #000; color: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 0 15px; font-weight: 700;">
                    <option value="SMC">Smart Money Concepts (SMC) ğŸ’</option>
                    <option value="Elliott Wave">Elliott Wave Theory ğŸŒŠ</option>
                    <option value="KAIA Master">KAIA Master Confluence ğŸ”¥</option>
                </select>

                <select id="timeframe" style="height: 50px; background: #000; color: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 0 15px; font-weight: 700;">
                    <option value="1m">1m</option><option value="5m">5m</option><option value="15m" selected>15m</option>
                    <option value="1H">1H</option><option value="4H">4H</option><option value="D">Daily</option>
                </select>
            </div>

            <button class="core-analyze-btn" id="run-btn" data-i18n="analyze_btn" style="height: 65px; width: 100%; font-size: 18px; font-weight: 900;">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>

            <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ù„ÙˆÙ† (Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ø­Ù‚Ù† Ø§Ù„Ù…Ù„ÙˆÙ†) -->
            <div id="result-box" style="display: none; margin-top: 25px; border-top: 2px solid var(--border); padding-top: 20px;">
                <div id="res-data-content"></div>
                <button onclick="document.getElementById('result-box').style.display='none'" 
                        data-i18n="analysis_hide_btn" 
                        style="width:100%; margin-top:15px; background:#1e293b; color:#fff; border:none; height:45px; border-radius:10px; cursor:pointer; font-weight: 800;">
                    Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªÙŠØ¬Ø© | Clear & Close
                </button>
            </div>

        </div>
        <!-- Ø§Ù„Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© -->
        <div class="calc-mini">
            <div class="calc-box">
                <div class="calc-screen" id="calc-display" style="height: 55px; font-size: 26px; border-radius: 10px; background: #000; border: 1px solid var(--border); display: flex; align-items: center; justify-content: flex-end; padding: 0 15px; color: var(--primary); font-family: monospace;">0</div>
                <div class="calc-btns" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px;">
                    <button onclick="clearCalc()" style="background: var(--danger); color: #fff; border:none; border-radius:8px; cursor:pointer; font-weight:900;">C</button>
                    <button onclick="inputCalc('/')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">Ã·</button>
                    <button onclick="inputCalc('*')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">Ã—</button>
                    <button onclick="deleteCalc()" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">â†</button>
                    
                    <button onclick="inputCalc('7')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer; padding:12px;">7</button>
                    <button onclick="inputCalc('8')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">8</button>
                    <button onclick="inputCalc('9')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">9</button>
                    <button onclick="inputCalc('-')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">-</button>
                    
                    <button onclick="inputCalc('4')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer; padding:12px;">4</button>
                    <button onclick="inputCalc('5')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">5</button>
                    <button onclick="inputCalc('6')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">6</button>
                    <button onclick="inputCalc('+')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">+</button>
                    
                    <button onclick="inputCalc('1')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer; padding:12px;">1</button>
                    <button onclick="inputCalc('2')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">2</button>
                    <button onclick="inputCalc('3')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">3</button>
                    <button onclick="resultCalc()" style="background: var(--primary); color: #000; grid-row: span 2; border:none; border-radius:8px; cursor:pointer; font-weight:900;">=</button>
                    
                    <button onclick="inputCalc('0')" style="grid-column: span 2; background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer; padding:12px;">0</button>
                    <button onclick="inputCalc('.')" style="background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">.</button>
                </div>
            </div>
        </div>

    </aside>

    <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù†: Ù…Ù†ØµØ© Ø§Ù„Ø´Ø§Ø±Øª Ø§Ù„ÙƒØ¨Ø±Ù‰ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <section class="main-chart-area">
        <div class="tradingview-widget-container" style="height: 100%; width: 100%;">
            <div id="tradingview_advanced_core" style="height: 100%; width: 100%;"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
            <script type="text/javascript">
                new TradingView.widget({
                    "autosize": true, "symbol": "FX:EURUSD", "interval": "15", "timezone": "Etc/UTC", "theme": "dark",
                    "style": "1", "locale": "ar", "toolbar_bg": "#f1f3f6", "enable_publishing": false,
                    "allow_symbol_change": true, "container_id": "tradingview_advanced_core"
                });
            </script>
        </div>
    </section>

</main>

<!-- ================= 3. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (Heatmap & Calendar) ================= -->
<section class="dash-row market-section" style="display: flex; gap: 20px; padding: 0 20px; margin-top: 20px;">
    <div class="dash-card" style="flex:1; background: var(--bg-panel); border-radius: 20px; border: 1px solid var(--border);">
        <div class="card-header" style="padding: 15px; font-weight: 800; border-bottom: 1px solid var(--border);">Ø®Ø±ÙŠØ·Ø© Ù‚ÙˆØ© Ø§Ù„Ø¹Ù…Ù„Ø§Øª</div>
        <div style="height: 350px;">
            <div class="tradingview-widget-container">
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-forex-heat-map.js" async>
                { "width": "100%", "height": "350", "currencies": ["EUR","USD","GBP","JPY","AUD","CAD","CHF"], "isTransparent": true, "colorTheme": "dark", "locale": "ar" }
                </script>
            </div>
        </div>
    </div>
    <div class="dash-card" style="flex:1; background: var(--bg-panel); border-radius: 20px; border: 1px solid var(--border);">
        <div class="card-header" style="padding: 15px; font-weight: 800; border-bottom: 1px solid var(--border);">Ø§Ù„Ø£Ø¬Ù†Ø¯Ø© Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</div>
        <div style="height: 350px;">
            <div class="tradingview-widget-container">
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
                { "width": "100%", "height": "350", "colorTheme": "dark", "isTransparent": true, "locale": "ar", "importanceFilter": "-1,0,1" }
                </script>
            </div>
        </div>
    </div>
</section>

<!-- ================= 4. Ø§Ù„Ù…ÙÙƒØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ© (Smart Trader Journal) ================= -->
<section class="notes-section">
    <div class="dash-card" style="background: var(--bg-panel); border-radius: 20px; border: 1px solid var(--border); overflow: hidden;">
        <div class="card-header" style="padding: 15px; font-weight: 800; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; color: var(--primary);">
            <i class="fa-solid fa-pen-fancy"></i>
            <span data-i18n="dash_notes_title">Ù…ÙÙƒØ±Ø© Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠØ© (Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ)</span>
        </div>
        <div style="padding: 20px; background: #0b1222;">
            <textarea id="trader-notes" class="trader-journal-area" data-i18n-placeholder="dash_notes_placeholder"
                      placeholder="Ø³Ø¬Ù„ Ù‡Ù†Ø§ ØªØ­Ù„ÙŠÙ„Ø§ØªÙƒØŒ Ø®Ø·Ø· ØªØ¯Ø§ÙˆÙ„ÙƒØŒ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø§Ù„Ù‡Ø§Ù…Ø©..."></textarea>
        </div>
    </div>
</section>

<!-- ================= 5. Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals) ================= -->

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± -->
<div id="risk-modal" class="floating-modal">
    <div class="modal-box">
        <h3 style="margin-bottom: 25px; color: var(--primary); font-weight: 900; text-align: center;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h3>
        <input type="number" id="balance" placeholder="Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (Balance)" class="modal-input" style="width:100%; background:#000; color:#fff; border:1px solid var(--border); padding:12px; border-radius:10px; margin-bottom:15px;">
        <input type="number" id="risk-lot" placeholder="Ø­Ø¬Ù… Ø§Ù„Ù„ÙˆØª (Lot Size)" class="modal-input" style="width:100%; background:#000; color:#fff; border:1px solid var(--border); padding:12px; border-radius:10px; margin-bottom:15px;">
        <input type="number" id="sl-pips-input" placeholder="Ø§Ù„Ø³ØªÙˆØ¨ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø· (Pips)" class="modal-input" style="width:100%; background:#000; color:#fff; border:1px solid var(--border); padding:12px; border-radius:10px;">
        <button class="core-analyze-btn" onclick="calculateRiskPercent()" style="width: 100%; margin-top: 25px;">Ø§Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©</button>
        <div id="risk-result" style="margin-top: 20px; text-align: center; font-weight: 900; color: var(--primary);"></div>
        <button onclick="document.getElementById('risk-modal').style.display='none'" style="margin-top: 20px; background: none; border: none; color: var(--danger); cursor: pointer; font-weight: 900; width: 100%;">Ø¥ØºÙ„Ø§Ù‚ [X]</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø· -->
<div id="pip-modal" class="floating-modal">
    <div class="modal-box" style="border-color: var(--success);">
        <h3 style="margin-bottom: 25px; color: var(--success); font-weight: 900; text-align: center;">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
        <input type="number" id="pip-lot-size" placeholder="Ø­Ø¬Ù… Ø§Ù„Ù„ÙˆØª" class="modal-input" style="width:100%; background:#000; color:#fff; border:1px solid var(--border); padding:12px; border-radius:10px; margin-bottom:15px;">
        <input type="number" id="pip-count" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·" class="modal-input" style="width:100%; background:#000; color:#fff; border:1px solid var(--border); padding:12px; border-radius:10px;">
        <button class="core-analyze-btn" style="background: var(--success); width: 100%; margin-top: 25px;" onclick="calculatePipProfit()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø±Ø¨Ø­ ($)</button>
        <div id="pip-result" style="margin-top: 20px; text-align: center; font-weight: 900; color: var(--success);"></div>
        <button onclick="document.getElementById('pip-modal').style.display='none'" style="margin-top: 20px; background: none; border: none; color: var(--danger); cursor: pointer; font-weight: 900; width: 100%;">Ø¥ØºÙ„Ø§Ù‚ [X]</button>
    </div>
</div>
<script>
let desktopFile = null;
const userToken = localStorage.getItem("token");
let isUserVerified = false;

// 1. Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆÙ…Ù†Ø¹ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„)
async function handleDesktopImage(event) {
    // --- [Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø®Ø§ØµÙŠØ© Ø§Ù„Ù„ØµÙ‚ Ø§Ù„Ø°ÙƒÙŠØ© Ctrl+V] ---
document.addEventListener('paste', async (e) => {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø­Ø§ÙØ¸Ø© (Clipboard)
    const item = Array.from(e.clipboardData.items).find(x => x.type.indexOf("image") !== -1);
    
    if (item) {
        const file = item.getAsFile();
        const statusLabel = document.getElementById("status-text");
        statusLabel.innerText = "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø´Ø§Ø±Øª Ø§Ù„Ù…Ù„Ø­Ù‚... â³";
        
        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¶ØºØ· Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡
            const options = { maxSizeMB: 0.7, maxWidthOrHeight: 1920, useWebWorker: true };
            desktopFile = await imageCompression(file, options);
            
            statusLabel.innerText = "ØªÙ… Ù„ØµÙ‚ Ø§Ù„Ø´Ø§Ø±Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…";
            statusLabel.style.color = "var(--primary)";
        } catch (err) {
            statusLabel.innerText = "ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ø­Ù‚Ø©";
        }
    }
});
// --------------------------------------------
    const file = event.target.files[0];
    if (!file) return;
    const statusLabel = document.getElementById("status-text");
    statusLabel.innerText = "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø´Ø§Ø±Øª Ù…Ø¤Ø³Ø³ÙŠØ§Ù‹... â³";
    try {
        const options = { maxSizeMB: 0.7, maxWidthOrHeight: 1920, useWebWorker: true };
        desktopFile = await imageCompression(file, options);
        statusLabel.innerText = "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø´Ø§Ø±Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…";
        statusLabel.style.color = "var(--primary)";
    } catch (e) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        statusLabel.innerText = "Ø¥Ù„ØµÙ‚ Ø§Ù„Ø´Ø§Ø±Øª Ù‡Ù†Ø§ ğŸ“¸";
    }
}

// 2. Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©)
async function executeDesktopAnalysis() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„
    if (document.getElementById("activation-banner") && document.getElementById("activation-banner").style.display === "block") {
        alert("ğŸ”’ ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ø±Ùƒ.");
        return;
    }

    if (!desktopFile) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø£Ùˆ Ù„ØµÙ‚ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø§Ø±Øª Ø£ÙˆÙ„Ø§Ù‹");

    const btn = document.getElementById("run-btn");
    const resBox = document.getElementById("result-box");
    const resContent = document.getElementById("res-data-content");

    btn.disabled = true;
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø´Ø§Ø±Øª ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©... ğŸš€";

    try {
        // Ø£. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø³ÙŠØ±ÙØ±
        const upFd = new FormData();
        upFd.append("chart", desktopFile);
        const upRes = await fetch("/api/upload-chart", { method: "POST", body: upFd });
        const { filename } = await upRes.json();

        // Ø¨. Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        const anFd = new FormData();
        anFd.append("filename", filename);
        anFd.append("timeframe", document.getElementById("timeframe").value);
        anFd.append("analysis_type", document.getElementById("strategy").value);
        anFd.append("lang", document.getElementById("language-select").value);

        const res = await fetch("/api/analyze-chart", {
            method: "POST",
            headers: { "Authorization": "Bearer " + userToken },
            body: anFd
        });

        const data = await res.json();
        if (res.ok) {
            const analysis = data.analysis;
            const bias = (analysis.market_state.directional_bias || "Neutral").toLowerCase();
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø°ÙƒÙŠ (Ø£Ø®Ø¶Ø± Ù„Ù„ØµØ¹ÙˆØ¯ / Ø£Ø­Ù…Ø± Ù„Ù„Ù‡Ø¨ÙˆØ·)
            let colorClass = bias.includes("bull") ? "report-bullish" : (bias.includes("bear") ? "report-bearish" : "report-neutral");
            let biasClass = bias.includes("bull") ? "bias-text-bull" : (bias.includes("bear") ? "bias-text-bear" : "");

            resBox.style.display = "block";
            resContent.innerHTML = `
                <div class="analysis-card ${colorClass}" style="background:rgba(11,18,34,0.95); padding:25px; border-radius:20px; line-height:1.8; position:relative;">
                    <div style="text-align:center; margin-bottom:20px;">
                        <h3 style="color:var(--primary); font-weight:900; letter-spacing:1px;">KAIA MASTER REPORT</h3>
                        <div style="font-size:14px; color:var(--muted);">${analysis.market || 'Market'} | ${analysis.timeframe || 'Active TF'}</div>
                    </div>

                    <div style="margin-bottom:20px; background:rgba(0,0,0,0.3); padding:15px; border-radius:12px; border-right:4px solid var(--primary);">
                        <strong style="display:block; color:var(--primary); margin-bottom:5px;">Ø§Ù„Ø®Ù„Ø§ØµØ© Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠØ©:</strong>
                        <p style="font-size:15px; margin:0;">${analysis.market_state.notes}</p>
                    </div>

                    <div style="font-size:20px; text-align:center; margin:20px 0; padding:10px; background:rgba(255,255,255,0.03); border-radius:10px;">
                        Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: <span class="${biasClass}">${analysis.market_state.directional_bias}</span>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div style="background:rgba(16,185,129,0.05); padding:12px; border-radius:10px; border:1px solid rgba(16,185,129,0.2);">
                            <strong style="color:#10b981; font-size:12px;">Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØµØ¹ÙˆØ¯Ø§Ù‹:</strong>
                            <div style="font-size:13px; font-family:monospace; margin-top:5px;">
                                ${analysis.key_levels.upside.map(l => `<div>â€¢ ${l.price}</div>`).join("")}
                            </div>
                        </div>
                        <div style="background:rgba(239,68,68,0.05); padding:12px; border-radius:10px; border:1px solid rgba(239,68,68,0.2);">
                            <strong style="color:#ef4444; font-size:12px;">Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‡Ø¨ÙˆØ·Ø§Ù‹:</strong>
                            <div style="font-size:13px; font-family:monospace; margin-top:5px;">
                                ${analysis.key_levels.downside.map(l => `<div>â€¢ ${l.price}</div>`).join("")}
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:20px; font-size:11px; text-align:center; color:var(--muted); opacity:0.7;">
                        Ø«Ù‚Ø© Ø§Ù„Ù…Ø­Ø±Ùƒ: ${analysis.confidence_score}% | ØªØ­Ù„ÙŠÙ„ ØªØ¹Ù„ÙŠÙ…ÙŠ Ù…Ø¤Ø³Ø³ÙŠ
                    </div>
                </div>
            `;
            syncDash(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
        } else {
            alert(data.detail || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ùƒ");
        }
    } catch (e) {
        alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø­Ø±Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
    } finally {
        btn.disabled = false;
        btn.innerText = "Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„";
    }
}

// --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© ---
function inputCalc(v) { 
    const d = document.getElementById("calc-display");
    if(d.innerText === "0") d.innerText = v;
    else d.innerText += v; 
}
function resultCalc() { 
    try { const d = document.getElementById("calc-display"); d.innerText = eval(d.innerText); }
    catch(e) { document.getElementById("calc-display").innerText = "Error"; } 
}
function deleteCalc() { const d = document.getElementById("calc-display"); d.innerText = d.innerText.slice(0, -1) || "0"; }
function clearCalc() { document.getElementById("calc-display").innerText = "0"; }

// 3. Ø¯Ø§Ù„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø±ØªØ¨Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Identity Sync)
async function syncDash() {
    if (!userToken) { window.location.href = "/"; return; }
    try {
        const res = await fetch("/api/me", { headers: { "Authorization": "Bearer " + userToken } });
        const u = await res.json();
        if (res.ok) {
            document.getElementById("dash-user").innerText = u.full_name;
            document.getElementById("dash-credits").innerText = u.credits;

            isUserVerified = u.is_verified;
            if (!u.is_verified) {
                document.getElementById("activation-banner").style.display = "block";
                document.getElementById("whatsapp-verify-link").href = `https://wa.me/970594060648?text=Ù…Ø±Ø­Ø¨Ø§Ù‹ KAIAØŒ Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ£Ø±ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ÙŠ: ${u.email}`;
                const runBtn = document.getElementById("run-btn");
                if (runBtn) {
                    runBtn.innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ â³";
                    runBtn.style.opacity = "0.5";
                    runBtn.style.pointerEvents = "none";
                }
            } else {
                document.getElementById("activation-banner").style.display = "none";
            }

            const iconPlace = document.getElementById("rank-icon-place");
            if (u.tier === "Platinum") iconPlace.innerHTML = '<i class="fa-solid fa-whale rank-icon tier-platinum"></i>';
            else if (u.tier === "Pro") iconPlace.innerHTML = '<i class="fa-solid fa-medal rank-icon tier-pro"></i>';
            else iconPlace.innerHTML = '<i class="fa-solid fa-tree rank-icon"></i>';

            document.body.style.visibility = "visible";
            document.body.style.opacity = "1";
        } else { window.location.href = "/"; }
    } catch(e) { window.location.href = "/"; }
}

// 4. Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
document.addEventListener("DOMContentLoaded", () => {
    const runBtn = document.getElementById("run-btn");
    if (runBtn) runBtn.onclick = executeDesktopAnalysis;

    const logoutBtn = document.getElementById("logout-btn");
    if (logoutBtn) {
        logoutBtn.onclick = () => { localStorage.removeItem("token"); location.reload(); };
    }
    syncDash();
});
</script>
</body>
</html>